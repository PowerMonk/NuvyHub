volumes:
  nuvy_builds:

services:
  # Servicio Web (Deno)
  web:
    build: ./web
    container_name: nuvyhub_web
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - nuvy_builds:/app/builds:rw
    environment:
      - BUILD_DIR=/app/builds
      - DOCKER_HOST=tcp://docker-proxy:2375
    depends_on:
      builder:
        condition: service_started
      docker-proxy:
        condition: service_started
    networks:
      - nuvy-network

  # Contenedor Builder (permanece activo esperando comandos)
  builder:
    build: ./builder
    container_name: nuvyhub_builder
    restart: unless-stopped
    volumes:
      - nuvy_builds:/app/builds:rw
    # El CMD ya está definido en el Dockerfile (tail -f /dev/null)
    # No necesitas sobrescribirlo aquí
    networks:
      - nuvy-network
    # Healthcheck para verificar que está corriendo
    healthcheck:
      test: ["CMD", "test", "-f", "/app/compile-esp32.sh"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Docker Socket Proxy
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: nuvyhub_docker_proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      CONTAINERS: 1
      POST: 1
      BUILD: 0
      COMMIT: 0
      EXEC: 1
      IMAGES: 1
      LOG_LEVEL: info
    networks:
      - nuvy-network

networks:
  nuvy-network:
    driver: bridge
