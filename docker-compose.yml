volumes:
  nuvy_builds:

services:
  # Servicio Web (Deno) - SIN socket montado
  web:
    build: ./web
    container_name: nuvyhub_web
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"  # Solo localhost
    volumes:
      - nuvy_builds:/app/builds:rw
    environment:
      - BUILD_DIR=/app/builds
      - DOCKER_HOST=tcp://docker-proxy:2375
      - BUILDER_IMAGE=nuvyhub-builder
    depends_on:
      - docker-proxy
    # Usuario no-root para mayor seguridad
    # Quito la linea del user por problemas de permisos
    # user: "1000:1000"
    networks:
      - nuvy-network

  # Contenedor Builder (con toolchain)
  builder:
    build: ./builder
    container_name: nuvyhub_builder
    command: ["tail", "-f", "/dev/null"]
    volumes:
      - nuvy_builds:/out:rw
    networks:
      - nuvy-network

  # Docker Socket Proxy (Tecnall/docker-socket-proxy)
  # Este contenedor FILTRA qué comandos Docker están permitidos
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: nuvyhub_docker_proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Solo lectura
    environment:
      # Permisos mínimos necesarios
      CONTAINERS: 1      # Permite listar/ver contenedores
      POST: 1           # Permite crear/ejecutar contenedores
      BUILD: 0          # NO permite construir imágenes
      COMMIT: 0         # NO permite commits
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 1           # Permite docker exec (necesario)
      IMAGES: 1         # Permite listar imágenes
      INFO: 0
      NETWORKS: 0
      NODES: 0
      PLUGINS: 0
      SERVICES: 0
      SESSION: 0
      SWARM: 0
      SYSTEM: 0
      TASKS: 0
      VOLUMES: 0
      # LOG_LEVEL: debug  # Descomenta para debug
    networks:
      - nuvy-network

networks:
  nuvy-network:
    driver: bridge
